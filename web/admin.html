<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - AI Voting System</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <h1>Admin - AI Voting System</h1>
    </header>
    <main>
      <section class="panel">
        <h2>Login</h2>
        <div class="row">
          <label>Username</label>
          <input id="adm-user" />
        </div>
        <div class="row">
          <label>Password</label>
          <input id="adm-pass" type="password" />
        </div>
        <div class="controls">
          <button id="adm-login">Login</button>
          <button id="adm-logout">Logout</button>
          <small id="adm-status"></small>
        </div>
      </section>
      <section class="panel">
        <h2>Export Data</h2>
        <p>Download all data as an Excel workbook.</p>
        <div class="controls">
          <a id="btn-download" href="/api/admin/export">Download Excel</a>
        </div>
        <div class="row">
          <a href="/">Back to App</a>
        </div>
      </section>

      <section class="panel">
        <h2>Admin Tools</h2>
        <div class="controls">
          <button id="btn-reset">Erase All Registered Faces</button>
        </div>
        <div class="row"><small id="reset-status"></small></div>
      </section>

      <section class="panel">
        <h2>Manage Candidates/Parties</h2>
        <div class="row"><label>Add New Party</label><input id="new-party" placeholder="Enter party name" /></div>
        <div class="controls"><button id="add-party">Add Party</button><small id="party-status"></small></div>
        <div class="row"><label>Current Parties:</label></div>
        <ul id="parties-list"></ul>
        <div class="controls"><button id="remove-party">Remove Selected</button></div>
      </section>

      <section class="panel">
        <h2>Register Voter Manually</h2>
        <div class="row"><label>Aadhar (12 digits)</label><input id="adm-aadhar" placeholder="Enter 12-digit Aadhar" maxlength="12" /></div>
        <div class="row"><label>Name</label><input id="adm-name" placeholder="Enter full name" /></div>
        <div class="controls"><button id="adm-register">Register Voter</button><small id="adm-reg-status"></small></div>
      </section>

      <section class="panel">
        <h2>Verify User</h2>
        <div class="row"><label>Aadhar</label><input id="ver-aadhar" /></div>
        <div class="row"><label>Name</label><input id="ver-name" /></div>
        <div class="row"><label>Photo</label><input id="ver-photo" type="file" accept="image/*" /></div>
        <div class="controls"><button id="ver-run">Verify</button><small id="ver-status"></small></div>
        <ul id="ver-result"></ul>
      </section>

      <section class="panel">
        <h2>Dashboard</h2>
        <div class="row"><strong>Total Registered IDs:</strong> <span id="stat-registered">0</span></div>
        <div class="row"><strong>Total Votes:</strong> <span id="stat-votes">0</span></div>
        <div style="max-width:500px;">
          <canvas id="chart" width="500" height="300"></canvas>
        </div>
        <div class="row"><strong>Recent Votes</strong></div>
        <ul id="recent"></ul>
      </section>

      <section class="panel">
        <h2>Votes</h2>
        <ul id="votes-list"></ul>
        <div class="controls">
          <button id="reset-votes">Reset All Votes</button>
          <small id="votes-status"></small>
        </div>
      </section>

      <section class="panel">
        <h2>Audit Log</h2>
        <p>Most recent actions appear below.</p>
        <ul id="audit-list"></ul>
      </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      async function requireAuth(){
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) {
          document.getElementById('adm-status').textContent = 'Please login as nivank or superior.';
        } else {
          document.getElementById('adm-status').textContent = 'Logged in as ' + me.user;
        }
      }
      document.getElementById('adm-login').addEventListener('click', async () => {
        const username = document.getElementById('adm-user').value.trim();
        const password = document.getElementById('adm-pass').value;
        const res = await fetch('/api/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
        const js = await res.json();
        if (!res.ok) { alert('Login failed'); return; }
        document.getElementById('adm-status').textContent = 'Logged in as ' + js.user;
        loadStats();
        loadVotes();
      });
      document.getElementById('adm-logout').addEventListener('click', async () => {
        await fetch('/api/admin/logout', { method: 'POST' });
        document.getElementById('adm-status').textContent = 'Logged out';
      });
      const resetStatusEl = document.getElementById('reset-status');
      async function loadStats(){
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) return;
        try {
          const js = await (await fetch('/api/admin/stats')).json();
          document.getElementById('stat-registered').textContent = js.totalRegistered;
          document.getElementById('stat-votes').textContent = js.totalVotes;
          const labels = Object.keys(js.votesByParty || {});
          const data = Object.values(js.votesByParty || {});
          const ctx = document.getElementById('chart').getContext('2d');
          new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: ['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6'] }]}});
          const recent = document.getElementById('recent');
          recent.innerHTML = (js.recent||[]).map(r => `<li>${r.date} ${r.time} - ${r.name} → ${r.vote}</li>`).join('');
        } catch(e) {}
      }
      document.getElementById('btn-reset').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        if (!confirm('Erase all registered faces? This cannot be undone.')) return;
        resetStatusEl.textContent = 'Erasing...';
        try {
          const res = await fetch('/api/reset-faces', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ confirm: 'yes' }) });
          const js = await res.json();
          if (!res.ok) throw new Error(js.error || 'Reset failed');
          resetStatusEl.textContent = 'All face data erased.';
          loadStats();
        } catch (e) {
          resetStatusEl.textContent = e.message;
          alert(e.message);
        }
      });
      // Votes table controls
      async function loadVotes(){
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) return;
        const js = await (await fetch('/api/admin/votes')).json();
        const list = document.getElementById('votes-list');
        if (!list) return;
        list.innerHTML = (js.rows||[]).map(r => `<li>#${r.index+1} ${r.date} ${r.time} - ${r.name} → ${r.vote} <button data-i="${r.index}">Delete</button></li>`).join('');
        list.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', async () => {
            const idx = parseInt(btn.getAttribute('data-i'), 10);
            if (!confirm('Delete this vote?')) return;
            const res = await fetch('/api/admin/votes/'+idx, { method: 'DELETE' });
            if (!res.ok) { alert('Delete failed'); return; }
            loadStats();
            loadVotes();
          });
        });
      }
      async function loadAudit(){
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) return;
        const js = await (await fetch('/api/admin/audit')).json();
        const list = document.getElementById('audit-list');
        if (!list) return;
        list.innerHTML = (js.rows||[]).reverse().map(r => `<li>${r.ts} [${r.user||'-'}] ${r.event}</li>`).join('');
      }
      document.getElementById('reset-votes').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        if (!confirm('Reset ALL votes? This cannot be undone.')) return;
        const status = document.getElementById('votes-status');
        status.textContent = 'Resetting...';
        const res = await fetch('/api/admin/reset-votes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ confirm: 'yes' }) });
        const js = await res.json();
        if (!res.ok) { alert('Reset failed'); status.textContent = 'Failed'; return; }
        status.textContent = 'All votes reset.';
        loadStats();
        loadVotes();
      });
      // Party management
      async function loadParties() {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) return;
        try {
          const res = await fetch('/api/admin/parties');
          const data = await res.json();
          const list = document.getElementById('parties-list');
          if (list) {
            list.innerHTML = data.parties.map(party => 
              `<li><input type="checkbox" value="${party}" /> ${party}</li>`
            ).join('');
          }
        } catch (e) {
          console.error('Error loading parties:', e);
        }
      }

      document.getElementById('add-party').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        const partyName = document.getElementById('new-party').value.trim();
        if (!partyName) { alert('Enter party name'); return; }
        
        const status = document.getElementById('party-status');
        status.textContent = 'Adding...';
        try {
          const res = await fetch('/api/admin/parties', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: partyName })
          });
          const data = await res.json();
          if (res.ok) {
            status.textContent = data.message;
            document.getElementById('new-party').value = '';
            loadParties();
          } else {
            status.textContent = data.error || 'Failed to add party';
          }
        } catch (e) {
          status.textContent = 'Error adding party';
        }
      });

      document.getElementById('remove-party').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        const checkboxes = document.querySelectorAll('#parties-list input[type="checkbox"]:checked');
        if (checkboxes.length === 0) { alert('Select parties to remove'); return; }
        if (!confirm(`Remove ${checkboxes.length} party/parties?`)) return;
        
        const status = document.getElementById('party-status');
        status.textContent = 'Removing...';
        try {
          for (const checkbox of checkboxes) {
            const res = await fetch('/api/admin/parties', {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: checkbox.value })
            });
            if (!res.ok) {
              const data = await res.json();
              alert(`Failed to remove ${checkbox.value}: ${data.error}`);
            }
          }
          status.textContent = 'Parties removed successfully';
          loadParties();
        } catch (e) {
          status.textContent = 'Error removing parties';
        }
      });

      requireAuth();
      loadStats();
      loadVotes();
      loadAudit();
      loadParties();

      // Admin manual register
      document.getElementById('adm-register').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        const aadhar = document.getElementById('adm-aadhar').value.trim();
        const name = document.getElementById('adm-name').value.trim();
        const status = document.getElementById('adm-reg-status');
        
        if (!aadhar || !name) { 
          alert('Aadhar and name are required'); 
          return; 
        }
        if (!/^\d{12}$/.test(aadhar)) {
          alert('Aadhar must be exactly 12 digits');
          return;
        }
        
        status.textContent = 'Registering voter...';
        try {
          const resp = await fetch('/api/admin/register', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ aadhar, name }) 
          });
          const js = await resp.json();
          if (!resp.ok) { 
            alert(js.error || 'Registration failed'); 
            status.textContent = 'Failed'; 
            return; 
          }
          status.textContent = `Voter ${name} (${aadhar}) registered successfully`;
          document.getElementById('adm-aadhar').value = '';
          document.getElementById('adm-name').value = '';
          loadStats();
        } catch (e) {
          status.textContent = 'Registration failed';
          alert('Registration failed: ' + e.message);
        }
      });

      // Admin verify
      document.getElementById('ver-run').addEventListener('click', async () => {
        const me = await (await fetch('/api/admin/me')).json();
        if (!me.user) { alert('Login first'); return; }
        const aadhar = document.getElementById('ver-aadhar').value.trim();
        const name = document.getElementById('ver-name').value.trim();
        const file = document.getElementById('ver-photo').files[0];
        const status = document.getElementById('ver-status');
        const resultEl = document.getElementById('ver-result');
        if (!aadhar || !name || !file) { alert('Enter aadhar, name, and choose a photo'); return; }
        status.textContent = 'Processing photo...';
        const b64 = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); });
        status.textContent = 'Verifying...';
        const resp = await fetch('/api/admin/verify', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ aadhar, name, image: b64 }) });
        const js = await resp.json();
        if (!resp.ok) { status.textContent = js.error || 'Failed'; return; }
        status.textContent = 'Done';
        resultEl.innerHTML = `
          <li>In Registry: ${js.registry ? 'Yes' : 'No'}</li>
          <li>Registry Name Match: ${js.registryNameMatch ? 'Yes' : 'No'}</li>
          <li>Registered in System: ${js.exists ? 'Yes' : 'No'}</li>
          <li>Profile Name Match: ${js.nameMatch ? 'Yes' : 'No'}</li>
          <li>Face Match: ${js.faceMatch ? 'Yes' : 'No'}</li>
          <li>Voted: ${js.voted ? 'Yes' : 'No'}</li>
          ${js.voted ? `<li>Vote time: ${js.voteDate} ${js.voteTime}</li>` : ''}
        `;
      });
    </script>
  </body>
  </html>


